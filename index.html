<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CHRONEX</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CHRONEX">

<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;900&family=Zen+Old+Mincho&display=swap" rel="stylesheet">

<style>
/* === CORE VARIABLES === */
:root {
    --bg-void: #050505;
    --neon-cyan: #00f3ff;
    --neon-pink: #ff0055;
    --neon-purple: #bc13fe;
    --neon-gold: #ffcc00;
    --forbidden-red: #ff3333;
    --safe-green: #33ff33;
    --silver-metal: #e0e5eb;
    --moon-pale: #eef2f5; 
    --border: rgba(255, 255, 255, 0.15);
    --border-strong: rgba(255, 255, 255, 0.35);
}

body {
    margin: 0; background-color: var(--bg-void); color: #fff;
    font-family: 'Orbitron', sans-serif; overflow: hidden;
    height: 100vh; width: 100vw;
    -webkit-touch-callout: none; user-select: none;
    display: flex; flex-direction: column; align-items: center;
    transition: background 1s ease;
}

/* === TRANSITION LAYER === */
#transition-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    pointer-events: none; opacity: 0; transition: opacity 0.3s;
}
#transition-layer.active { opacity: 1; pointer-events: auto; }
#transition-text {
    font-family: 'Zen Old Mincho', serif; color: var(--neon-cyan);
    font-size: 20px; letter-spacing: 4px; text-align: center;
    text-shadow: 0 0 10px var(--neon-cyan); white-space: nowrap;
}
.blink-caret { animation: blink 0.8s infinite; }

/* === QUEST CLEAR OVERLAY === */
#quest-clear-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 500;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transform: scale(1.5);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#quest-clear-overlay.active { opacity: 1; transform: scale(1); pointer-events: auto; }
.clear-text {
    font-size: 32px; font-weight: 900; color: var(--neon-gold);
    text-shadow: 0 0 20px var(--neon-gold); letter-spacing: 5px;
    border: 2px solid var(--neon-gold); padding: 20px 40px;
    background: rgba(255, 204, 0, 0.1); transform: rotate(-5deg);
}

/* === BACKGROUND LAYERS === */
.bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0; transition: opacity 1.5s; pointer-events: none; }
.bg-layer.active { opacity: 1; }

#bg-sunny { background: radial-gradient(circle at center, #553300 0%, #000 80%); }
#bg-sunny::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 200, 0, 0.1) 20deg, transparent 40deg, rgba(255, 200, 0, 0.1) 60deg, transparent 80deg, rgba(255, 200, 0, 0.1) 100deg, transparent 120deg, rgba(255, 200, 0, 0.1) 140deg, transparent 160deg); animation: sunRotate 60s linear infinite; }
#bg-sunny::after { content: ""; position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, rgba(255, 220, 100, 0.2) 0%, transparent 60%); animation: sunPulse 4s ease-in-out infinite alternate; }
@keyframes sunRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes sunPulse { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }

#bg-cloudy { background: #0a1116; }
#bg-cloudy::before { content: ""; position: absolute; top: 0; left: 0; width: 200%; height: 100%; background: repeating-linear-gradient(90deg, transparent 0%, rgba(0, 243, 255, 0.05) 20%, transparent 40%); background-size: 50% 100%; animation: fogFlow 20s linear infinite; }
#bg-cloudy::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at bottom, rgba(200, 200, 210, 0.15) 0%, transparent 70%); }
@keyframes fogFlow { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

#bg-rain { background: linear-gradient(to bottom, #050510, #000); }
.rain-drop { position: absolute; top:-10vh; background: rgba(0, 243, 255, 0.5); width: 1px; height: 60px; animation: rainFall linear infinite; }
@keyframes rainFall { to { transform: translateY(110vh); } }

#bg-thunder { background: radial-gradient(circle at 30% 30%, #220033 0%, #000 90%); }
.flash-overlay { position: absolute; width:100%; height:100%; background: rgba(255,255,255,0.15); opacity:0; pointer-events:none; }
@keyframes flashAnim { 0%,100%{opacity:0;} 2%{opacity:0.4;} 4%{opacity:0;} }

.grid-floor { position: absolute; width: 200%; height: 200%; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px); bottom: -50%; left: -50%; z-index: -1; }

/* === TOP SHORTCUTS === */
.top-dock { width: 100%; padding: 15px 0; display: flex; justify-content: center; gap: 12px; z-index: 10; }
.icon-btn {
    width: 60px; height: 60px; background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border); border-radius: 12px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-decoration: none; color: #fff; backdrop-filter: blur(5px);
    transition: all 0.3s ease; position: relative; overflow: visible;
}
.icon-btn:hover { border-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.1); box-shadow: 0 0 15px var(--neon-cyan), 0 0 30px rgba(0, 243, 255, 0.4); transform: scale(1.05); }
.icon-symbol { font-size: 18px; margin-bottom: 4px; color: var(--silver-metal); transition: 0.3s; }
.icon-btn:hover .icon-symbol { color: #fff; text-shadow: 0 0 10px #fff; }
.icon-label { font-size: 8px; color: #aaa; letter-spacing: 0.5px; }

/* === CLOCK & SEARCH === */
.main-section { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: relative; }
.clock-container { position: relative; width: 300px; height: 300px; display: flex; justify-content: center; align-items: center; }

.c-ring { position: absolute; border-radius: 50%; border: 1px solid transparent; }
.c-ring-1 { width: 100%; height: 100%; border-top-color: var(--neon-purple); border-bottom-color: var(--neon-purple); animation: spin 20s linear infinite; opacity: 0.6; }
.c-ring-2 { width: 85%; height: 85%; border-left-color: var(--neon-cyan); border-right-color: var(--neon-cyan); animation: spin 10s linear infinite reverse; box-shadow: 0 0 10px rgba(0,243,255,0.2); }
@keyframes spin { to { transform: rotate(360deg); } }

.glitch-wrapper { position: relative; z-index: 10; text-align: center; }

.time-display {
    display: flex; align-items: center; justify-content: center;
    font-family: 'Orbitron', monospace; color: #fff;
    text-shadow: 0 0 15px var(--neon-cyan);
    font-size: 46px; 
    font-weight: 900; letter-spacing: 2px;
    width: 350px; 
    font-variant-numeric: tabular-nums;
}
#h-min { width: 170px; text-align: right; display: inline-block; }
.time-colon { width: 30px; text-align: center; display: inline-block; animation: blink 1s infinite; }
#sec-text { width: 80px; text-align: left; display: inline-block; }

@keyframes blink { 50% { opacity: 0; } }

.glitch-active .time-display { animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; color: var(--neon-pink); text-shadow: 2px 0 var(--neon-cyan), -2px 0 var(--neon-gold); }
@keyframes glitch-skew { 0%{transform:skew(0deg);} 20%{transform:skew(-10deg);} 40%{transform:skew(10deg);} 60%{transform:skew(-5deg);} 80%{transform:skew(5deg);} 100%{transform:skew(0deg);} }

.date-row { font-family: 'Cinzel', serif; font-size: 12px; color: var(--neon-pink); letter-spacing: 3px; margin-top: 15px; display: flex; justify-content: center; gap: 10px; }

.search-container { margin-top: 15px; width: 100%; display: flex; justify-content: center; position: relative; }
#search-input {
    background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); border-radius: 20px;
    color: #fff; padding: 8px 15px; width: 200px; font-family: 'Orbitron'; font-size: 12px;
    text-align: center; outline: none; transition: all 0.3s; letter-spacing: 1px;
}
#search-input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); width: 240px; background: rgba(0, 243, 255, 0.05); }

/* === MODULES GRID === */
.modules-container { width: 100%; max-width: 450px; padding: 0 20px 30px 20px; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; z-index: 10; }

.weather-card {
    width: 100%; height: 60px;
    background: linear-gradient(90deg, rgba(0, 243, 255, 0.05), rgba(0,0,0,0.8));
    border: 1px solid var(--neon-cyan); border-radius: 8px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; box-sizing: border-box; cursor: pointer; position: relative; overflow: hidden;
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
}
.w-scan-line { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--neon-cyan); opacity: 0.5; box-shadow: 0 0 10px var(--neon-cyan); animation: scan 4s ease-in-out infinite; }
@keyframes scan { 0%{left:0;} 50%{left:100%;} 100%{left:0;} }
.w-temp { font-size: 24px; font-weight: bold; text-shadow: 0 0 5px var(--neon-cyan); }
.w-icon { font-size: 24px; }

.app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
.app-card {
    height: 90px; background: rgba(255,255,255,0.03);
    border: 2px solid var(--border-strong); border-radius: 8px;
    padding: 10px; position: relative; overflow: hidden;
    cursor: pointer; transition: 0.2s;
    display: flex; flex-direction: column; justify-content: space-between;
}
.app-card:hover { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
.app-card:active { transform: scale(0.98); }
.app-title { font-size: 10px; color: var(--neon-cyan); letter-spacing: 1px; }
.app-icon-bg { position: absolute; right: 5px; bottom: 5px; font-size: 36px; opacity: 0.15; color: #fff; }
.card-forbidden { border-color: rgba(255, 51, 51, 0.5); }
.card-forbidden .app-title { color: var(--forbidden-red); }

/* === MODALS === */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 8, 0.98); backdrop-filter: blur(15px);
    z-index: 200; opacity: 0; pointer-events: none; transform: scale(1.1);
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    display: flex; flex-direction: column;
}
.modal.active { opacity: 1; pointer-events: auto; transform: scale(1); }
.modal-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); z-index: 5; }
.modal-title { font-size: 16px; color: var(--neon-cyan); letter-spacing: 2px; font-weight: bold; }
.close-btn { font-size: 24px; color: #fff; cursor: pointer; margin-left:15px; }

.header-icons { display: flex; align-items: center; gap: 15px; }
.head-icon { font-size: 20px; color: #aaa; cursor: pointer; transition:0.3s; position:relative; }
.head-icon:hover { color: var(--neon-cyan); }
.settings-btn:hover { transform: rotate(90deg); }
.trash-btn:hover { color: var(--forbidden-red); transform: scale(1.1); }

.modal-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }

/* QUEST */
#modal-quest.active .modal-content { animation: questOpen 0.5s ease-out forwards; }
@keyframes questOpen { from { transform: rotateX(20deg) translateY(50px); opacity: 0; } to { transform: rotateX(0) translateY(0); opacity: 1; } }
.quest-card { background: rgba(0, 0, 0, 0.9); border: 1px solid #333; margin-bottom: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-left-width: 4px; }
.qc-s { border-left-color: #ffcc00; } .qc-a { border-left-color: #ff0055; } .qc-b { border-left-color: #00f3ff; } .qc-c { border-left-color: #888; }
.quest-input-area { display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,20,30,0.8); padding: 10px; border: 1px solid var(--neon-cyan); }
#quest-in-text { flex: 1; background: #000; border: none; color: #fff; padding: 5px; outline: none; }
#quest-rank-sel { background: #000; color: #fff; border: 1px solid var(--neon-cyan); font-family: 'Orbitron'; }
#quest-add-btn { background: var(--neon-cyan); color: #000; border: none; padding: 0 15px; font-weight: bold; cursor: pointer; }

/* === LUNAR PHASE & CALENDAR === */
#modal-moon .modal-title { font-family: 'Zen Old Mincho', serif; letter-spacing: 3px; }

/* LARGE MOON (TOP SECTION) - Text Removed */
#moon-visual-container {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 25px;
}
#moon-canvas {
    width: 220px; height: 220px;
    border-radius: 50%;
    filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
    animation: moonFloat 6s ease-in-out infinite alternate;
}
@keyframes moonFloat { 0%{transform:translateY(0);} 100%{transform:translateY(-10px);} }

/* CALENDAR (BOTTOM SECTION) */
.calendar-container {
    width: 100%; max-width: 350px; margin: 0 auto;
    font-family: 'Orbitron', sans-serif;
}
.calendar-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px;
    color: var(--neon-cyan); font-size: 18px; letter-spacing: 2px;
}
.cal-nav-btn { background: transparent; border: none; color: #aaa; font-size: 18px; cursor: pointer; padding: 5px 10px; }
.cal-nav-btn:hover { color: #fff; }

.calendar-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;
    text-align: center;
}
.weekday-header { font-size: 10px; color: #888; padding-bottom: 5px; }
.wh-sun { color: var(--forbidden-red); }
.wh-sat { color: var(--neon-cyan); }

.calendar-cell {
    aspect-ratio: 1 / 1;
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 4px;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    padding-top: 5px; position: relative;
}
.cal-date-num { font-size: 12px; margin-bottom: 5px; }
.cal-moon-icon { width: 24px; height: 24px; }

/* Date Colors */
.date-sun, .date-holiday { color: var(--forbidden-red); }
.date-sat { color: var(--neon-cyan); }
.date-weekday { color: #fff; }
/* Today highlight */
.date-today { border-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.05); }
/* Other month days */
.date-other-month { opacity: 0.3; }

/* VITAL */
.vital-pod { width: 220px; height: 220px; border-radius: 50%; border: 4px solid #222; margin: 20px auto; display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
.vital-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border-top: 4px solid var(--neon-pink); border-right: 4px solid transparent; animation: spin 2s linear infinite; }
#vital-timer { font-size: 48px; font-weight: bold; color: #fff; text-shadow: 0 0 10px var(--neon-pink); z-index: 10; font-family: 'Orbitron'; }

/* NOISE SWITCH */
.switch-box { display: flex; align-items: center; gap: 10px; margin-top: 15px; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 20px; border: 1px solid #333; }
.switch-label { font-size: 10px; font-family: 'Orbitron'; color: #aaa; }
.toggle-chk { appearance: none; width: 30px; height: 15px; background: #333; border-radius: 15px; position: relative; outline: none; cursor: pointer; transition: 0.3s; }
.toggle-chk::after { content: ""; position: absolute; top: 2px; left: 2px; width: 11px; height: 11px; background: #888; border-radius: 50%; transition: 0.3s; }
.toggle-chk:checked { background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
.toggle-chk:checked::after { transform: translateX(15px); background: #000; }

/* ARCHIVE */
#modal-archive.active { animation: archiveFlash 0.3s; }
@keyframes archiveFlash { 0% { background: #500; } 100% { background: #000; } }

/* Archive List View */
#archive-list-view { display: flex; flex-direction: column; height: 100%; }
.archive-item {
    background: rgba(255, 50, 50, 0.05); border: 1px solid #522; padding: 15px; margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s;
}
.archive-item:hover { background: rgba(255, 50, 50, 0.2); border-color: var(--forbidden-red); transform: translateX(5px); }
.ai-title { font-family: 'Zen Old Mincho', serif; font-size: 16px; color: #eebbcc; }
.ai-date { font-family: 'Orbitron'; font-size: 10px; color: #744; }
.list-del-btn { padding: 5px 10px; color: var(--forbidden-red); border: 1px solid var(--forbidden-red); font-size: 10px; background:transparent; cursor: pointer; margin-left: 10px; transition: 0.2s; }
.list-del-btn:hover { background: var(--forbidden-red); color: #000; }

/* Archive Editor View */
#archive-editor-view { display: none; flex-direction: column; height: 100%; }
#archive-title-input {
    background: transparent; border: none; border-bottom: 2px solid var(--forbidden-red);
    color: var(--neon-gold); font-family: 'Orbitron'; font-size: 18px; padding: 10px; margin-bottom: 10px; outline: none; width: 100%; box-sizing: border-box;
}
.archive-editor { flex: 1; background: rgba(20, 0, 0, 0.3); border: 1px solid var(--forbidden-red); padding: 15px; color: #ccaaaa; font-family: 'Zen Old Mincho', serif; font-size: 14px; line-height: 1.8; outline: none; resize: none; width: 100%; box-sizing: border-box; }

/* Trash View */
#archive-trash-view { display: none; flex-direction: column; height: 100%; padding: 20px; }
.trash-item {
    background: rgba(0, 0, 0, 0.5); border: 1px solid #444; padding: 15px; margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; color: #777;
}
.trash-actions { display: flex; gap: 8px; }
.btn-restore { border:1px solid var(--safe-green); color:var(--safe-green); background:transparent; font-size:10px; cursor:pointer; padding:5px; }
.btn-purge { border:1px solid var(--forbidden-red); color:var(--forbidden-red); background:transparent; font-size:10px; cursor:pointer; padding:5px; }
.btn-restore:hover { background:var(--safe-green); color:#000; }
.btn-purge:hover { background:var(--forbidden-red); color:#000; }
.trash-empty { color: #555; text-align: center; margin-top: 50px; font-family: 'Orbitron'; }

.arch-btn { background: transparent; border: 1px solid #555; color: #aaa; padding: 6px 12px; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; transition: 0.2s; }
.arch-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

.btn-new { border-color: var(--neon-cyan); color: var(--neon-cyan); width: 100%; margin-bottom: 10px; padding: 10px; font-weight: bold; }
.btn-new:hover { background: rgba(0,243,255,0.1); color: #fff; }

/* Security Overlay */
#security-overlay { display:flex; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:999; flex-direction:column; justify-content:center; align-items:center; backdrop-filter:blur(10px); }

.overlay-top-left {
    position: absolute; top: 20px; left: 20px;
    color: var(--forbidden-red);
    font-family: 'Zen Old Mincho', serif;
    font-size: 18px; letter-spacing: 2px;
    text-shadow: 0 0 5px var(--forbidden-red);
}

.tiny-hint { position: absolute; bottom: 5px; right: 5px; font-size: 8px; color: #111; font-family: 'Orbitron'; user-select: none; }
.tiny-hint:hover { color: #333; }

/* Forgot Password Link */
.forgot-link {
    margin-top: 20px; font-size: 10px; color: #ccc; cursor: pointer;
    font-family: 'Zen Old Mincho', serif; text-decoration: underline; transition: 0.3s;
    text-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
}
.forgot-link:hover { color: var(--neon-cyan); text-shadow: 0 0 8px var(--neon-cyan); }

/* Hint Modal */
#hint-modal {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 250px; padding: 20px; background: #000; border: 1px solid var(--neon-cyan);
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); z-index: 1001;
    display: none; flex-direction: column; align-items: center; text-align: center;
}
.hint-text {
    color: #fff; font-family: 'Zen Old Mincho', serif; font-size: 14px; margin-bottom: 15px; line-height: 1.6;
}

/* Bottom Right Pass Reveal */
#pass-reveal {
    position: absolute; bottom: 40px; right: 50px;
    font-size: 10px; color: rgba(255,255,255,0.2); font-family: 'Orbitron';
    pointer-events: none;
}

/* Undo Toast */
.undo-toast {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #111; border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
    padding: 10px 30px; font-family: 'Orbitron'; font-size: 12px; letter-spacing: 1px;
    box-shadow: 0 0 15px rgba(0,243,255,0.3); z-index: 1000;
    display: none; align-items: center; justify-content: space-between; gap: 20px;
    animation: slideUp 0.3s ease-out;
}
.undo-toast.active { display: flex; }
@keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
.undo-action { font-weight: bold; text-decoration: underline; cursor: pointer; color: #fff; }

/* Disabled state */
.btn-disabled { opacity: 0.3; cursor: not-allowed; border-color: #333 !important; color: #333 !important; pointer-events: none; }
</style>
</head>
<body>

    <div id="transition-layer">
        <div id="transition-text">>> SYSTEM INITIALIZING...</div>
    </div>

    <div id="quest-clear-overlay"><div class="clear-text">MISSION COMPLETED</div></div>

    <div id="bg-sunny" class="bg-layer"></div>
    <div id="bg-cloudy" class="bg-layer active"></div>
    <div id="bg-rain" class="bg-layer"><div id="rain-container"></div></div>
    <div id="bg-thunder" class="bg-layer"><div class="flash-overlay"></div></div>
    <div class="grid-floor"></div>

    <div class="top-dock">
        <a class="icon-btn" href="https://youtube.com"><div class="icon-symbol">‚ñ∂</div><div class="icon-label">YOUTUBE</div></a>
        <a class="icon-btn" href="https://gemini.google.com"><div class="icon-symbol">‚ú¶</div><div class="icon-label">GEMINI</div></a>
        <a class="icon-btn" href="https://music.apple.com"><div class="icon-symbol">‚ô´</div><div class="icon-label">MUSIC</div></a>
        <a class="icon-btn" href="https://maps.google.com">
            <div class="icon-symbol"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg></div>
            <div class="icon-label">MAPS</div>
        </a>
    </div>

    <div class="main-section">
        <div class="clock-container">
            <div class="c-ring c-ring-1"></div>
            <div class="c-ring c-ring-2"></div>
            <div class="glitch-wrapper" id="clock-wrapper">
                <div class="time-display" id="time-container">
                    <span id="h-min">00:00</span><span class="time-colon">:</span><span id="sec-text">00</span>
                </div>
                <div class="date-row"><span id="date-text">--.--.--</span><span id="day-text">[---]</span></div>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="SEARCH DATASPHERE..." onkeypress="handleSearch(event)">
                </div>
            </div>
        </div>
    </div>

    <div class="modules-container">
        <div class="weather-card" onclick="window.open('https://weather.yahoo.co.jp/weather/jp/22/5010.html')">
            <div class="w-scan-line"></div>
            <div style="display:flex; align-items:center;">
                <div class="w-icon" id="w-icon">‚òÅ</div>
                <div class="w-loc">SHIZUOKA<br><span style="font-size:8px; color:#666;">LIVE MONITOR</span></div>
            </div>
            <div class="w-temp" id="w-temp">--¬∞C</div>
        </div>
        <div style="height:10px;"></div>
        <div class="app-grid">
            <div class="app-card" onclick="triggerTransition('modal-quest', '>> Âõ†ÊûúÂæãÊßãÈÄ†„ÄÅËß£Êûê‰∏≠...')">
                <div class="app-title">QUEST BOARD</div><div class="app-status">Active: <span id="m-count">0</span></div><div class="app-icon-bg">‚öî</div>
            </div>
            <div class="app-card" onclick="triggerTransition('modal-moon', '>> Ë°õÊòüËªåÈÅì„ÄÅÊçïÊçâ...')">
                <div class="app-title">LUNAR PHASE</div><div class="app-status">Moon: <span id="idx-moon-age">--</span></div><div class="app-icon-bg">‚òæ</div>
            </div>
            <div class="app-card" onclick="triggerTransition('modal-vital', '>> ÁîüÂëΩÈºìÂãï„ÄÅÂêåË™ø...')">
                <div class="app-title">VITAL KEEPER</div><div class="app-status">Life Support</div><div class="app-icon-bg">‚ô•</div>
            </div>
            <div class="app-card card-forbidden" onclick="triggerTransition('modal-archive', '>> Â∞ÅÂç∞„Çµ„É¨„Ç∑Ë®òÊÜ∂„ÄÅËß£Âáç...')">
                <div class="app-title">FORBIDDEN ARCHIVE</div>
                <div class="app-status" style="color:#aa5555;">[[ LOCKED ]]</div>
                <div class="app-icon-bg">üëÅ</div>
            </div>
        </div>
    </div>

    <div id="modal-quest" class="modal">
        <div class="modal-header"><span class="modal-title">QUEST BOARD</span><span class="close-btn" onclick="closeModal('modal-quest')">√ó</span></div>
        <div class="modal-content">
            <div class="quest-input-area">
                <select id="quest-rank-sel"><option value="S">S</option><option value="A">A</option><option value="B">B</option><option value="C" selected>C</option></select>
                <input type="text" id="quest-in-text" placeholder="Mission Name...">
                <button id="quest-add-btn" onclick="addQuest()">ADD</button>
            </div>
            <div id="quest-list"></div>
        </div>
    </div>

    <div id="modal-moon" class="modal">
        <div class="modal-header">
            <span class="modal-title">ÊúàË™≠„ÉéÊö¶</span>
            <span class="close-btn" onclick="closeModal('modal-moon')">√ó</span>
        </div>
        <div class="modal-content">
            <div id="moon-visual-container">
                <canvas id="moon-canvas" width="220" height="220"></canvas>
            </div>

            <div id="lunar-calendar-wrapper" class="calendar-container"></div>
        </div>
    </div>

    <div id="modal-vital" class="modal">
        <div class="modal-header"><span class="modal-title">VITAL KEEPER</span><span class="close-btn" onclick="closeModal('modal-vital')">√ó</span></div>
        <div class="modal-content" style="display:flex; flex-direction:column; align-items:center;">
            <div class="vital-pod"><div class="vital-ring"></div><div id="vital-timer">25:00</div></div>
            <div style="display:flex; gap:20px; margin-top:20px;">
                <button class="arch-btn" style="border-color:var(--neon-pink); color:var(--neon-pink);" onclick="startVital()">START</button>
                <button class="arch-btn" style="border-color:#fff; color:#fff;" onclick="pauseVital()">STOP</button>
                <button class="arch-btn" onclick="resetVital()">RESET</button>
            </div>
            <div class="switch-box">
                <input type="checkbox" id="vital-noise-toggle" class="toggle-chk" checked>
                <span class="switch-label">NOISE LINK</span>
            </div>
        </div>
    </div>

    <div id="modal-archive" class="modal">
        <div class="modal-header">
            <span class="modal-title" style="font-family: 'Zen Old Mincho', serif;">Á¶ÅÂøå„ÉéÊõ∏Â∫´</span>
            <div class="header-icons">
                <div class="head-icon trash-btn" onclick="openTrash()">üóë</div>
                <div class="head-icon settings-btn" onclick="openSettings()">‚öô</div>
                <span class="close-btn" onclick="closeModal('modal-archive')">√ó</span>
            </div>
        </div>
        
        <div class="modal-content" style="position:relative; padding:0; height:100%; display:flex; flex-direction:column;">
            
            <div id="archive-list-view" style="padding:20px;">
                <button class="arch-btn btn-new" onclick="createNewMemo()">+ ËôöÁÑ°„É®„É™„ÉéÂâµÈÄ†„ÇíÁ∂¥„É¨...</button>
                <div id="archive-list-container"></div>
            </div>

            <div id="archive-editor-view" style="padding:20px;">
                <input type="text" id="archive-title-input" placeholder="Ê±ù„ÉéÁúüÂêç„É≤Ê≠§Âá¶„ÉãÂàª„É°...">
                <textarea id="archive-editor-area" class="archive-editor" placeholder="Êñ∞„ÉäË®òÊÜ∂„ÅÆÊñ≠Áâá„É≤Ë®òÈå≤„Çª„É®..."></textarea>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="arch-btn" onclick="closeEditor()">‚Üê BACK</button>
                    <div style="display:flex; gap:10px;">
                        <button id="btn-save" class="arch-btn" style="color:var(--neon-cyan); border-color:var(--neon-cyan);" onclick="saveCurrentMemo()">SAVE DATA</button>
                    </div>
                </div>
            </div>

            <div id="archive-trash-view">
                <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:var(--forbidden-red); font-size:12px;">DELETED FILES</span>
                    <button class="arch-btn" onclick="closeTrash()">‚Üê BACK</button>
                </div>
                <div id="archive-trash-container"></div>
            </div>

            <div id="security-overlay" style="display:flex;">
                <div class="overlay-top-left">Á¶ÅÂøå„ÉéÊõ∏Â∫´</div>

                <div id="sec-title" style="color:var(--forbidden-red); font-size:24px; font-weight:bold; letter-spacing:5px; margin-bottom:20px; text-align:center;">[[ Ë≠¶ÂëäÔºöÊé•ËøëÊ®©Èôê„ÉªÊãíÁµ∂ ]]</div>
                <div id="sec-sub" style="color:#fff; font-size:12px; margin-bottom:10px; font-family:'Orbitron';">>> ÊöóÂè∑ÈçµÔºà„Ç≥„Éº„ÉâÔºâ„ÉéÊèêÁ§∫„É≤Ê±Ç„É†</div>
                <input type="tel" id="passcode-input" maxlength="4" style="background:transparent; border:2px solid var(--forbidden-red); color:var(--forbidden-red); font-family:'Orbitron'; font-size:32px; width:150px; text-align:center; outline:none; letter-spacing:10px; margin-bottom:20px;">
                <button id="sec-btn" onclick="handleSecurityInput()" style="background:var(--forbidden-red); color:#000; border:none; padding:10px 40px; font-family:'Orbitron'; font-weight:bold; cursor:pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);">UNLOCK</button>
                
                <div class="forgot-link" onclick="openHintModal()">Ë®òÊÜ∂„É≤Âñ™Â§±„Çª„Ç∑ËÄÖ</div>

                <div id="pass-reveal"></div>

                <div id="hint-modal">
                    <div class="hint-text">ÁúüÂÆü„Éè<br>Ë¶ñÁïå„ÉéÈöÖÔºà„Éü„ÇÆ„Ç∑„ÇøÔºâ„Éã<br>ÊΩú„É†...</div>
                    <button class="arch-btn" style="font-size:10px;" onclick="closeHintModal()">CLOSE</button>
                </div>
            </div>

            <div id="undo-toast" class="undo-toast">
                <span>„Éá„Éº„ÇøÊ∂àÂéª... Âæ©ÂÖÉ„Ç∑„Éû„Çπ„ÉØÔºü</span>
                <span class="undo-action" onclick="undoDelete()">UNDO</span>
            </div>

        </div>
    </div>

    <script>
        // === CORE CLOCK ===
        const days = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
        function updateClock() {
            const now = new Date();
            document.getElementById('h-min').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('sec-text').innerText = String(now.getSeconds()).padStart(2,'0');
            document.getElementById('date-text').innerText = now.toLocaleDateString();
            document.getElementById('day-text').innerText = `[${days[now.getDay()]}]`;
            
            // Update Mini Moon Age on Home
            const age = getMoonAge(now);
            const el = document.getElementById('idx-moon-age');
            if(el) el.innerText = age.toFixed(1);

            if(Math.random() < 0.20) { 
                const cw = document.getElementById('clock-wrapper'); cw.classList.add('glitch-active');
                setTimeout(()=> cw.classList.remove('glitch-active'), 300);
            }
        }
        setInterval(updateClock, 1000); updateClock();

        function handleSearch(e) {
            if (e.key === 'Enter') {
                const query = document.getElementById('search-input').value;
                if(query) { window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank'); document.getElementById('search-input').value = ''; }
            }
        }

        // === WEATHER ===
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.9756&longitude=138.3828&current_weather=true');
                const data = await res.json();
                document.getElementById('w-temp').innerText = `${data.current_weather.temperature}¬∞C`;
                const code = data.current_weather.weathercode;
                let type="cloudy", icon="‚òÅ";
                if(code<=1){type="sunny";icon="‚òÄ";} else if(code<=3){type="cloudy";icon="‚õÖ";} else if(code<=67){type="rain";icon="‚òÇ";} else if(code<=99){type="thunder";icon="‚ö°";}
                document.getElementById('w-icon').innerText = icon;
                setBg(type);
            } catch(e) {}
        }
        function setBg(type) {
            document.querySelectorAll('.bg-layer').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('bg-'+type); if(target) target.classList.add('active');
            const rc = document.getElementById('rain-container'); rc.innerHTML = "";
            if(type==='rain'||type==='thunder') for(let i=0;i<30;i++) { let d=document.createElement('div');d.className='rain-drop';d.style.left=Math.random()*100+'vw';d.style.animationDuration=(0.3+Math.random()*0.4)+'s';d.style.animationDelay=Math.random()+'s';rc.appendChild(d); }
            document.querySelector('.flash-overlay').style.animation = (type==='thunder') ? "flashAnim 5s infinite" : "none";
        }
        fetchWeather(); setInterval(fetchWeather, 600000);

        // === MODALS ===
        function triggerTransition(id, txt) {
            document.getElementById('transition-text').innerHTML = txt + '<span class="blink-caret">_</span>';
            const ol = document.getElementById('transition-layer'); ol.classList.add('active');
            setTimeout(() => { ol.classList.remove('active'); openModal(id); }, 1200);
        }
        function openModal(id) { 
            document.getElementById(id).classList.add('active'); 
            if(id==='modal-moon') {
                initLargeMoon(); // Initialize Large Moon Animation
                initLunarCalendar(); // Initialize Calendar
            }
            if(id==='modal-archive') { 
                initArchiveSecurity(); 
                renderArchiveList();   
            }
        }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            if(id==='modal-archive') document.getElementById('passcode-input').value = "";
        }

        // === QUEST BOARD ===
        let quests = JSON.parse(localStorage.getItem('quests_v3')) || [];
        renderQuests();
        function addQuest() {
            const t = document.getElementById('quest-in-text').value;
            if(t) { quests.push({t:t, r:document.getElementById('quest-rank-sel').value}); localStorage.setItem('quests_v3', JSON.stringify(quests)); renderQuests(); document.getElementById('quest-in-text').value=""; }
        }
        function renderQuests() {
            const el = document.getElementById('quest-list'); el.innerHTML = "";
            quests.forEach((q,i) => {
                const d = document.createElement('div'); d.className = `quest-card qc-${q.r.toLowerCase()}`;
                d.innerHTML = `<div class="rank-badge">${q.r}</div><div>${q.t}</div><span class="check-btn" onclick="completeQuest(${i})">‚úî</span>`;
                el.appendChild(d);
            });
            document.getElementById('m-count').innerText = quests.length;
        }
        function completeQuest(i) {
            document.getElementById('quest-clear-overlay').classList.add('active');
            quests.splice(i,1); localStorage.setItem('quests_v3', JSON.stringify(quests)); renderQuests();
            setTimeout(()=>document.getElementById('quest-clear-overlay').classList.remove('active'), 1500);
        }

        // === LUNAR LOGIC ===
        function getMoonAge(date) {
            const base = new Date(2000, 0, 6);
            const diff = date - base;
            const days = diff / (1000*60*60*24);
            return Math.abs(days % 29.53058867);
        }

        function drawMoonBody(ctx, cx, cy, r, phase, glow) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.fillStyle = "#111"; ctx.fill(); 

            ctx.save();
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.fillStyle = "#eef2f5";
            if(glow) { ctx.shadowBlur = 30; ctx.shadowColor = "rgba(238,242,245,0.6)"; }
            ctx.fill();
            ctx.restore();

            ctx.fillStyle = "rgba(10,14,20,0.95)";
            let p = phase; 
            if(p <= 0.5) {
                const w = r * Math.cos(p * 2 * Math.PI); 
                ctx.beginPath();
                if(p < 0.25) {
                    ctx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, true); 
                    ctx.ellipse(cx, cy, Math.abs(w), r, 0, Math.PI/2, -Math.PI/2, true);
                } else {
                    ctx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, true); 
                    ctx.ellipse(cx, cy, Math.abs(w), r, 0, -Math.PI/2, Math.PI/2, false); 
                }
                ctx.fill();
            } else {
                const w = r * Math.cos(p * 2 * Math.PI);
                ctx.beginPath();
                if(p < 0.75) {
                    ctx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, false); 
                    ctx.ellipse(cx, cy, Math.abs(w), r, 0, Math.PI/2, -Math.PI/2, false); 
                } else {
                    ctx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, false); 
                    ctx.ellipse(cx, cy, Math.abs(w), r, 0, -Math.PI/2, Math.PI/2, true);
                }
                ctx.fill();
            }
        }

        // --- LARGE MOON RENDERER ---
        function initLargeMoon() {
            const cvs = document.getElementById('moon-canvas');
            const ctx = cvs.getContext('2d');
            const today = new Date();
            const age = getMoonAge(today);
            const phase = age / 29.53058867;
            
            // Draw Large Moon (Text removed)
            drawMoonBody(ctx, 110, 110, 100, phase, true);
        }

        // --- CALENDAR LOGIC ---
        let currentCalDate = new Date();

        function initLunarCalendar() {
            renderLunarCalendar(currentCalDate);
        }

        function prevMonth() {
            currentCalDate.setMonth(currentCalDate.getMonth() - 1);
            renderLunarCalendar(currentCalDate);
        }

        function nextMonth() {
            currentCalDate.setMonth(currentCalDate.getMonth() + 1);
            renderLunarCalendar(currentCalDate);
        }

        function isHoliday(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            if (m === 1 && d === 1) return true; 
            if (m === 2 && d === 11) return true; 
            if (m === 2 && d === 23) return true; 
            if (m === 3 && d === 20) return true; 
            if (m === 4 && d === 29) return true; 
            if (m === 5 && d === 3) return true; 
            if (m === 5 && d === 4) return true; 
            if (m === 5 && d === 5) return true; 
            if (m === 8 && d === 11) return true; 
            if (m === 9 && d === 23) return true; 
            if (m === 11 && d === 3) return true; 
            if (m === 11 && d === 23) return true; 
            function isHappyMonday(month, weekNum) {
                if (m !== month) return false;
                const firstDayOfWeek = new Date(y, m - 1, 1).getDay();
                const targetDay = 1 + (weekNum - 1) * 7 + (1 - firstDayOfWeek + 7) % 7;
                return d === targetDay;
            }
            if (isHappyMonday(1, 2)) return true; 
            if (isHappyMonday(7, 3)) return true; 
            if (isHappyMonday(9, 3)) return true; 
            if (isHappyMonday(10, 2)) return true; 
            return false;
        }

        function renderLunarCalendar(baseDate) {
            const container = document.getElementById('lunar-calendar-wrapper');
            container.innerHTML = "";

            const year = baseDate.getFullYear();
            const month = baseDate.getMonth();
            const today = new Date();

            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = `
                <button class="cal-nav-btn" onclick="prevMonth()"><</button>
                <span>${year} . ${String(month + 1).padStart(2, '0')}</span>
                <button class="cal-nav-btn" onclick="nextMonth()">></button>
            `;
            container.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            weekdays.forEach((day, i) => {
                const wh = document.createElement('div');
                wh.className = `weekday-header ${i === 0 ? 'wh-sun' : (i === 6 ? 'wh-sat' : '')}`;
                wh.innerText = day;
                grid.appendChild(wh);
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const totalDays = lastDay.getDate();

            for (let i = 0; i < startingDayOfWeek; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell date-other-month';
                grid.appendChild(cell);
            }

            for (let d = 1; d <= totalDays; d++) {
                const currentDate = new Date(year, month, d);
                const dayOfWeek = currentDate.getDay();
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                let dateClass = 'date-weekday';
                if (isHoliday(currentDate) || dayOfWeek === 0) dateClass = 'date-sun';
                else if (dayOfWeek === 6) dateClass = 'date-sat';

                if (currentDate.toDateString() === today.toDateString()) {
                    cell.classList.add('date-today');
                }

                const dateNum = document.createElement('div');
                dateNum.className = `cal-date-num ${dateClass}`;
                dateNum.innerText = d;
                cell.appendChild(dateNum);

                const age = getMoonAge(currentDate);
                const phase = age / 29.53058867;
                const cvs = document.createElement('canvas');
                cvs.width = 24; cvs.height = 24;
                cvs.className = 'cal-moon-icon';
                const ctx = cvs.getContext('2d');
                drawMoonBody(ctx, 12, 12, 10, phase, false); 
                cell.appendChild(cvs);

                grid.appendChild(cell);
            }
            container.appendChild(grid);
        }

        // === VITAL KEEPER ===
        let vitalInt, vitalTime=25*60;
        function startVital(){ 
            if(!vitalInt) {
                vitalInt=setInterval(()=>{ vitalTime--; updateVital(); if(vitalTime<=0)resetVital(); },1000); 
            }
        }
        function pauseVital(){ 
            clearInterval(vitalInt); vitalInt=null; 
        }
        function resetVital(){ 
            pauseVital(); vitalTime=25*60; updateVital(); 
        }
        function updateVital(){ document.getElementById('vital-timer').innerText = `${Math.floor(vitalTime/60).toString().padStart(2,'0')}:${(vitalTime%60).toString().padStart(2,'0')}`; }

        // === ARCHIVE SYSTEM ===
        let archives = JSON.parse(localStorage.getItem('chronex_archives')) || [];
        let trashArchives = JSON.parse(localStorage.getItem('chronex_trash')) || [];
        let currentEditId = null;
        let isSetupMode = false;
        
        let lastDeletedItem = null;
        let undoTimeout = null;

        const archiveEditor = document.getElementById('archive-editor-area');
        const titleInput = document.getElementById('archive-title-input');
        const listView = document.getElementById('archive-list-view');
        const editorView = document.getElementById('archive-editor-view');
        const trashView = document.getElementById('archive-trash-view');
        
        const overlay = document.getElementById('security-overlay');
        const passIn = document.getElementById('passcode-input');
        const secTitle = document.getElementById('sec-title');
        const secSub = document.getElementById('sec-sub');
        const secBtn = document.getElementById('sec-btn');
        const passReveal = document.getElementById('pass-reveal');
        const glChars = "ÔæäÔæãÔæåÔæçÔæéÔæèÔæêÔæëÔæíÔæìÔæîÔæïÔæñÔæóÔæòÔæôÔæöÔæõÔæúÔæù0123456789XKZW@#&";

        function renderArchiveList() {
            const container = document.getElementById('archive-list-container');
            container.innerHTML = "";
            archives.forEach(item => {
                const div = document.createElement('div');
                div.className = "archive-item";
                div.innerHTML = `
                    <div style="flex:1;" onclick="openEditor(${item.id})">
                        <div class="ai-title">${item.title}</div>
                        <div class="ai-date">${item.date}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:var(--neon-cyan); font-size:10px; margin-right:10px;">>> OPEN</span>
                        <button class="list-del-btn" onclick="deleteFromList(${item.id})">üóë</button>
                    </div>`;
                container.appendChild(div);
            });
        }

        // --- SECURITY LOGIC ---
        function initArchiveSecurity() {
            const storedPass = localStorage.getItem('chronex_passcode');
            passIn.value = "";
            switchView('list'); 
            overlay.style.display = "flex"; 
            document.getElementById('hint-modal').style.display = "none";

            if (!storedPass) {
                isSetupMode = true;
                secTitle.innerText = "SYSTEM INITIALIZATION";
                secTitle.style.color = "var(--neon-cyan)";
                secSub.innerText = "SET NEW PASSCODE (4 DIGITS)";
                secBtn.innerText = "REGISTER";
                secBtn.style.backgroundColor = "var(--neon-cyan)";
                passIn.style.borderColor = "var(--neon-cyan)";
                passIn.style.color = "var(--neon-cyan)";
                passReveal.innerText = "";
                document.querySelector('.forgot-link').style.display = 'none';
            } else {
                isSetupMode = false;
                secTitle.innerText = "[[ Ë≠¶ÂëäÔºöÊé•ËøëÊ®©Èôê„ÉªÊãíÁµ∂ ]]";
                secTitle.style.color = "var(--forbidden-red)";
                secSub.innerText = ">> ÊöóÂè∑ÈçµÔºà„Ç≥„Éº„ÉâÔºâ„ÉéÊèêÁ§∫„É≤Ê±Ç„É†";
                secBtn.innerText = "UNLOCK";
                secBtn.style.backgroundColor = "var(--forbidden-red)";
                passIn.style.borderColor = "var(--forbidden-red)";
                passIn.style.color = "var(--forbidden-red)";
                document.querySelector('.forgot-link').style.display = 'block';
                
                passReveal.innerText = storedPass;
            }
        }

        function handleSecurityInput() {
            const val = passIn.value;
            if(!val || val.length !== 4 || isNaN(val)) {
                shakeOverlay();
                return;
            }

            if(isSetupMode) {
                localStorage.setItem('chronex_passcode', val);
                alert("PASSCODE REGISTERED.\nSYSTEM SECURED.");
                overlay.style.display = "none";
            } else {
                const stored = localStorage.getItem('chronex_passcode');
                if(val === stored) {
                    overlay.style.display = "none";
                } else {
                    shakeOverlay();
                    passIn.value = "";
                }
            }
        }

        function openHintModal() {
            document.getElementById('hint-modal').style.display = 'flex';
        }
        function closeHintModal() {
            document.getElementById('hint-modal').style.display = 'none';
        }

        function shakeOverlay() {
            overlay.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }], { duration: 200 });
        }

        function openSettings() {
            const newPass = prompt("„ÄêSYSTEM SETTINGS„Äë\nÊñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (4Ê°Å)");
            if(newPass && newPass.length === 4 && !isNaN(newPass)) {
                localStorage.setItem('chronex_passcode', newPass);
                alert("PASSWORD UPDATED.");
            } else if (newPass !== null) {
                alert("INVALID FORMAT. UPDATE ABORTED.");
            }
        }

        // --- TRASH SYSTEM ---
        function openTrash() {
            renderTrashList();
            switchView('trash');
        }

        function closeTrash() {
            renderArchiveList();
            switchView('list');
        }

        function renderTrashList() {
            const container = document.getElementById('archive-trash-container');
            container.innerHTML = "";
            if(trashArchives.length === 0) {
                container.innerHTML = "<div class='trash-empty'>// NULL VOID //</div>";
                return;
            }
            trashArchives.forEach(item => {
                const div = document.createElement('div');
                div.className = "trash-item";
                div.innerHTML = `
                    <div>
                        <div style="font-size:14px; color:#999;">${item.title}</div>
                        <div style="font-size:8px;">${item.date}</div>
                    </div>
                    <div class="trash-actions">
                        <button class="btn-restore" onclick="restoreFromTrash(${item.id})">RESTORE</button>
                        <button class="btn-purge" onclick="purgeFromTrash(${item.id})">PURGE</button>
                    </div>`;
                container.appendChild(div);
            });
        }

        function deleteFromList(id) {
            const idx = archives.findIndex(a => a.id === id);
            if(idx !== -1) {
                lastDeletedItem = archives[idx]; 
                trashArchives.push(archives[idx]);
                archives.splice(idx, 1);
                
                updateStorage();
                renderArchiveList();
                showUndoToast();
            }
        }

        function showUndoToast() {
            const t = document.getElementById('undo-toast');
            t.classList.add('active');
            if(undoTimeout) clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                t.classList.remove('active');
                lastDeletedItem = null; 
            }, 4000); 
        }

        function undoDelete() {
            if(lastDeletedItem) {
                trashArchives = trashArchives.filter(item => item.id !== lastDeletedItem.id);
                archives.push(lastDeletedItem);
                archives.sort((a,b) => a.id - b.id);
                
                updateStorage();
                renderArchiveList();
                document.getElementById('undo-toast').classList.remove('active');
                lastDeletedItem = null;
            }
        }

        function restoreFromTrash(id) {
            const idx = trashArchives.findIndex(a => a.id === id);
            if(idx !== -1) {
                archives.push(trashArchives[idx]);
                trashArchives.splice(idx, 1);
                updateStorage();
                renderTrashList();
            }
        }

        function purgeFromTrash(id) {
            if(confirm("PERMANENTLY DELETE? CANNOT BE UNDONE.")) {
                const idx = trashArchives.findIndex(a => a.id === id);
                if(idx !== -1) {
                    trashArchives.splice(idx, 1);
                    updateStorage();
                    renderTrashList();
                }
            }
        }

        function updateStorage() {
            localStorage.setItem('chronex_archives', JSON.stringify(archives));
            localStorage.setItem('chronex_trash', JSON.stringify(trashArchives));
        }

        // --- EDITOR & GLITCH ---
        function createNewMemo() {
            currentEditId = null;
            titleInput.value = "";
            archiveEditor.value = "";
            switchView('editor');
        }

        function openEditor(id) {
            const item = archives.find(a => a.id === id);
            if(item) {
                currentEditId = id;
                titleInput.value = item.title;
                switchView('editor');
                runDecryptAnim(item.content);
            }
        }

        function runDecryptAnim(realText) {
            if(!realText) realText = "";
            archiveEditor.value = "";
            const len = realText.length || 30; 
            let step = 0; const stepsTotal = 20; 
            archiveEditor.readOnly = true;
            
            const timer = setInterval(() => {
                step++; let display = "";
                for(let i=0; i<len; i++) {
                    if(i < (len * (step/stepsTotal))) {
                        display += realText.charAt(i);
                    } else {
                        display += glChars.charAt(Math.floor(Math.random()*glChars.length));
                    }
                }
                archiveEditor.value = display;
                if(step >= stepsTotal) { 
                    clearInterval(timer); 
                    archiveEditor.value = realText; 
                    archiveEditor.readOnly = false; 
                }
            }, 30);
        }

        function saveCurrentMemo() {
            const title = titleInput.value || "UNTITLED_FILE";
            const content = archiveEditor.value;
            const date = new Date().toLocaleDateString();
            if(currentEditId) {
                const idx = archives.findIndex(a => a.id === currentEditId);
                if(idx !== -1) { archives[idx] = { id: currentEditId, title, content, date }; }
            } else {
                const newId = Date.now();
                archives.push({ id: newId, title, content, date });
                currentEditId = newId; 
            }
            updateStorage();
            alert("DATA SAVED.");
            closeEditor();
        }

        function closeEditor() {
            switchView('list');
            renderArchiveList();
        }

        function switchView(view) {
            listView.style.display = 'none';
            editorView.style.display = 'none';
            trashView.style.display = 'none';

            if(view === 'list') {
                listView.style.display = 'flex';
            } else if (view === 'editor') {
                editorView.style.display = 'flex';
            } else if (view === 'trash') {
                trashView.style.display = 'flex';
            }
        }
    </script>
</body>
</html>
