<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AETHER CHRONICLE</title>

<link rel="manifest" href="manifest.json" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;900&family=Zen+Old+Mincho&display=swap" rel="stylesheet">

<style>
/* === CORE VARIABLES === */
:root {
    --bg-void: #050505;
    --neon-cyan: #00f3ff;
    --neon-pink: #ff0055;
    --neon-purple: #bc13fe;
    --neon-gold: #ffcc00;
    --forbidden-red: #ff3333;
    --silver-metal: #e0e5eb;
    --border: rgba(255, 255, 255, 0.15);
}

body {
    margin: 0; background-color: var(--bg-void); color: #fff;
    font-family: 'Orbitron', sans-serif; overflow: hidden;
    height: 100vh; width: 100vw;
    -webkit-touch-callout: none; user-select: none;
    display: flex; flex-direction: column; align-items: center;
    transition: background 1s ease;
}

/* === BACKGROUND LAYERS === */
.bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0; transition: opacity 1s; }
.bg-layer.active { opacity: 1; }

#bg-sunny { background: radial-gradient(circle at top, #221800 0%, #000 90%); }
#bg-sunny::after { content:""; position:absolute; width:100%; height:100%; background: radial-gradient(circle, rgba(255,170,0,0.1) 10%, transparent 50%); }

#bg-cloudy { background: radial-gradient(circle, #1a2a33 0%, #000 90%); }
#bg-rain { background: linear-gradient(to bottom, #050510, #000); }
.rain-drop { position: absolute; top:-10vh; background: rgba(0, 243, 255, 0.4); width: 1px; height: 60px; animation: rainFall linear infinite; }
@keyframes rainFall { to { transform: translateY(110vh); } }

#bg-thunder { background: radial-gradient(circle at 30% 30%, #220033 0%, #000 90%); }
.flash-overlay { position: absolute; width:100%; height:100%; background: rgba(255,255,255,0.1); opacity:0; pointer-events:none; }
@keyframes flashAnim { 0%,100%{opacity:0;} 5%{opacity:0.3;} 10%{opacity:0;} }

.grid-floor { position: absolute; width: 200%; height: 200%; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px); bottom: -50%; left: -50%; z-index: -1; }

/* === SHORTCUTS ("Mowatto" Effect) === */
.top-dock { width: 100%; padding: 15px 0; display: flex; justify-content: center; gap: 12px; z-index: 10; }
.icon-btn {
    width: 60px; height: 60px; background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border); border-radius: 12px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-decoration: none; color: #fff; backdrop-filter: blur(5px);
    transition: all 0.3s ease; position: relative; overflow: visible;
}
.icon-btn::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 12px; box-shadow: 0 0 0 transparent; transition: 0.3s;
}
.icon-btn:hover {
    border-color: var(--neon-cyan);
    background: rgba(0, 243, 255, 0.1);
    box-shadow: 0 0 15px var(--neon-cyan), 0 0 30px rgba(0, 243, 255, 0.4);
    transform: scale(1.05);
}
.icon-symbol { font-size: 18px; margin-bottom: 4px; color: var(--silver-metal); transition: 0.3s; }
.icon-btn:hover .icon-symbol { color: #fff; text-shadow: 0 0 10px #fff; }
.icon-label { font-size: 8px; color: #aaa; letter-spacing: 0.5px; }

/* === CLOCK (Fixed Width & Same Style) === */
.main-section { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: relative; }
.clock-container { position: relative; width: 280px; height: 280px; display: flex; justify-content: center; align-items: center; }

/* Rings */
.c-ring { position: absolute; border-radius: 50%; border: 1px solid transparent; }
.c-ring-1 { width: 100%; height: 100%; border-top-color: var(--neon-purple); border-bottom-color: var(--neon-purple); animation: spin 20s linear infinite; opacity: 0.6; }
.c-ring-2 { width: 85%; height: 85%; border-left-color: var(--neon-cyan); border-right-color: var(--neon-cyan); animation: spin 10s linear infinite reverse; box-shadow: 0 0 10px rgba(0,243,255,0.2); }
@keyframes spin { to { transform: rotate(360deg); } }

/* Time Text */
.time-display {
    display: flex; align-items: baseline; justify-content: center;
    font-family: 'Orbitron', monospace; /* Monospace for fixed width numbers */
    color: #fff; text-shadow: 0 0 15px var(--neon-cyan);
    z-index: 10;
}
.time-part {
    font-size: 52px; font-weight: 900; letter-spacing: 2px;
    width: 160px; text-align: right; /* Fixed width to prevent jitter */
}
.time-colon { font-size: 52px; font-weight: 900; margin: 0 5px; animation: blink 1s infinite; }
.time-sec {
    font-size: 52px; font-weight: 900; letter-spacing: 2px;
    width: 90px; text-align: left; /* Same style as hours */
    color: #fff; /* Same color */
    text-shadow: 0 0 15px var(--neon-cyan); /* Same effect */
}
.date-row { font-family: 'Cinzel', serif; font-size: 12px; color: var(--neon-pink); letter-spacing: 3px; margin-top: 10px; display: flex; justify-content: center; gap: 10px; }

/* Glitch Animation */
.glitch-active .time-display { animation: glitch-anim 0.2s cubic-bezier(.25, .46, .45, .94) 3; }
@keyframes glitch-anim {
    0% { transform: translate(0); }
    20% { transform: translate(-3px, 3px); }
    40% { transform: translate(-3px, -3px); }
    60% { transform: translate(3px, 3px); }
    80% { transform: translate(3px, -3px); }
    100% { transform: translate(0); }
}

/* === MODULE GRID === */
.modules-container { width: 100%; max-width: 450px; padding: 0 20px 30px 20px; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; z-index: 10; }

.weather-card {
    width: 100%; height: 60px;
    background: linear-gradient(90deg, rgba(0, 243, 255, 0.05), rgba(0,0,0,0.8));
    border: 1px solid var(--neon-cyan); border-radius: 8px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; box-sizing: border-box;
    cursor: pointer; position: relative; overflow: hidden;
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
}
.w-scan-line { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--neon-cyan); opacity: 0.5; box-shadow: 0 0 10px var(--neon-cyan); animation: scan 4s ease-in-out infinite; }
@keyframes scan { 0%{left:0;} 50%{left:100%;} 100%{left:0;} }
.w-temp { font-size: 24px; font-weight: bold; text-shadow: 0 0 5px var(--neon-cyan); }
.w-icon { font-size: 24px; }

.app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
.app-card {
    height: 90px; background: rgba(255,255,255,0.03);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 10px; position: relative; overflow: hidden;
    cursor: pointer; transition: 0.2s;
    display: flex; flex-direction: column; justify-content: space-between;
}
.app-card:active { transform: scale(0.98); }
.app-title { font-size: 10px; color: var(--neon-cyan); letter-spacing: 1px; }
.app-icon-bg { position: absolute; right: 5px; bottom: 5px; font-size: 36px; opacity: 0.15; color: #fff; }
.card-forbidden { border-color: rgba(255, 51, 51, 0.3); }
.card-forbidden .app-title { color: var(--forbidden-red); }

/* === MODALS COMMON === */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(5, 5, 8, 0.98); backdrop-filter: blur(15px);
    z-index: 200; 
    opacity: 0; pointer-events: none; transform: scale(1.1);
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    display: flex; flex-direction: column;
}
.modal.active { opacity: 1; pointer-events: auto; transform: scale(1); }
.modal-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
.modal-title { font-size: 16px; color: var(--neon-cyan); letter-spacing: 2px; font-weight: bold; }
.close-btn { font-size: 24px; color: #fff; cursor: pointer; }
.modal-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }

/* === M1: QUEST BOARD (Holo-Grid BG & Animation) === */
#modal-quest { perspective: 1000px; }
#modal-quest.active .modal-content { animation: questOpen 0.5s ease-out forwards; }
@keyframes questOpen { 
    from { transform: rotateX(20deg) translateY(50px); opacity: 0; } 
    to { transform: rotateX(0) translateY(0); opacity: 1; } 
}
#modal-quest .modal-content {
    background-image: 
        linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
}
.quest-input-area { display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,20,30,0.8); padding: 10px; border: 1px solid var(--neon-cyan); box-shadow: 0 0 10px rgba(0,243,255,0.1); }
#quest-rank-sel { background: #000; color: #fff; border: 1px solid var(--neon-cyan); font-family: 'Orbitron'; }
#quest-in-text { flex: 1; background: #000; border: none; color: #fff; padding: 5px; outline: none; }
#quest-add-btn { background: var(--neon-cyan); color: #000; border: none; padding: 0 15px; font-weight: bold; cursor: pointer; }

.quest-card {
    background: rgba(0, 0, 0, 0.9); border: 1px solid #333; margin-bottom: 8px; padding: 12px;
    display: flex; justify-content: space-between; align-items: center; position: relative;
    border-left-width: 4px;
}
.rank-badge { font-size: 16px; font-weight: bold; width: 30px; text-align: center; margin-right: 10px; }
.rank-S { color: var(--rank-s); text-shadow: 0 0 5px var(--rank-s); }
.rank-A { color: var(--rank-a); text-shadow: 0 0 5px var(--rank-a); }
.rank-B { color: var(--rank-b); text-shadow: 0 0 5px var(--rank-b); }
.rank-C { color: var(--rank-c); }
.qc-s { border-left-color: var(--rank-s); box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); }
.qc-a { border-left-color: var(--rank-a); }
.qc-b { border-left-color: var(--rank-b); }
.qc-c { border-left-color: var(--rank-c); }

/* === M2: NOISE TUNER (Active Viz & Animation) === */
#modal-tuner.active .tuner-viz { animation: tunerBoot 0.4s ease-out; }
@keyframes tunerBoot { from { height: 0; opacity: 0; } to { height: 200px; opacity: 1; } }
.tuner-viz { width: 100%; height: 200px; background: #000; border: 1px solid #333; box-shadow: inset 0 0 20px rgba(0,255,0,0.1); border-radius: 4px; margin-bottom: 20px; }
.tuner-ctrl { display: flex; justify-content: center; align-items: center; gap: 20px; }

/* === M3: VITAL KEEPER (Heartbeat & Animation) === */
#modal-vital.active .vital-pod { animation: podOpen 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes podOpen { from { transform: scale(0) rotate(-90deg); } to { transform: scale(1) rotate(0); } }
.vital-pod { width: 220px; height: 220px; border-radius: 50%; border: 4px solid #222; margin: 20px auto; display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
.vital-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border-top: 4px solid var(--neon-pink); border-right: 4px solid transparent; animation: spin 2s linear infinite; }
.vital-heart-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,0,85,0.2); overflow: hidden; }
.vital-heart-line::after { content:''; position: absolute; top: 0; left: -50px; width: 50px; height: 100%; background: linear-gradient(90deg, transparent, var(--neon-pink), transparent); animation: heartbeat 1.5s ease-in-out infinite; }
@keyframes heartbeat { 0% { left: -50px; } 100% { left: 100%; } }
#vital-timer { font-size: 48px; font-weight: bold; color: #fff; text-shadow: 0 0 10px var(--neon-pink); z-index: 10; font-family: 'Orbitron'; }

/* === M4: FORBIDDEN ARCHIVE (Red Animation) === */
#modal-archive.active { animation: archiveFlash 0.3s; }
@keyframes archiveFlash { 0% { background: #500; } 100% { background: #000; } }
#modal-archive { background: #000; }
#modal-archive .modal-title { color: var(--forbidden-red); text-shadow: 0 0 10px var(--forbidden-red); }
.archive-editor { flex: 1; background: rgba(20, 0, 0, 0.3); border: 1px solid var(--forbidden-red); padding: 15px; color: #ccaaaa; font-family: 'Zen Old Mincho', serif; font-size: 14px; line-height: 1.8; outline: none; resize: none; width: 100%; box-sizing: border-box; box-shadow: inset 0 0 30px rgba(50,0,0,0.5); }
.encrypted-text { font-family: 'Orbitron', monospace; color: var(--forbidden-red); text-shadow: 0 0 5px var(--forbidden-red); pointer-events: none; }
.arch-btn { background: transparent; border: 1px solid var(--forbidden-red); color: var(--forbidden-red); padding: 8px 12px; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; flex: 1; margin: 0 2px; transition: 0.2s; }
.arch-btn:hover { background: var(--forbidden-red); color: #000; }

.footer-info { font-size: 10px; color: #555; text-align: center; width: 100%; padding-bottom: 5px; margin-top: 10px; }

</style>
</head>
<body>

    <div id="bg-sunny" class="bg-layer"></div>
    <div id="bg-cloudy" class="bg-layer active"></div>
    <div id="bg-rain" class="bg-layer"><div id="rain-container"></div></div>
    <div id="bg-thunder" class="bg-layer"><div class="flash-overlay"></div></div>
    <div class="grid-floor"></div>

    <div class="top-dock">
        <a class="icon-btn" href="https://youtube.com"><div class="icon-symbol">‚ñ∂</div><div class="icon-label">YOUTUBE</div></a>
        <a class="icon-btn" href="https://gemini.google.com"><div class="icon-symbol">‚ú¶</div><div class="icon-label">GEMINI</div></a>
        <a class="icon-btn" href="https://music.apple.com"><div class="icon-symbol">‚ô´</div><div class="icon-label">MUSIC</div></a>
        <a class="icon-btn" href="https://maps.google.com"><div class="icon-symbol">üó∫</div><div class="icon-label">MAPS</div></a>
    </div>

    <div class="main-section">
        <div class="clock-container">
            <div class="c-ring c-ring-1"></div>
            <div class="c-ring c-ring-2"></div>
            <div class="glitch-wrapper" id="clock-wrapper">
                <div class="time-display">
                    <div class="time-part" id="h-min">00:00</div>
                    <div class="time-colon">:</div>
                    <div class="time-sec" id="sec">00</div>
                </div>
                <div class="date-row">
                    <span id="date-text">--.--.--</span>
                    <span id="day-text">[---]</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modules-container">
        <div class="weather-card" onclick="window.open('https://weather.yahoo.co.jp/weather/jp/22/5010.html')">
            <div class="w-scan-line"></div>
            <div style="display:flex; align-items:center;">
                <div class="w-icon" id="w-icon">‚òÅ</div>
                <div class="w-loc">SHIZUOKA<br><span style="font-size:8px; color:#666;">LIVE MONITOR</span></div>
            </div>
            <div class="w-temp" id="w-temp">--¬∞C</div>
        </div>

        <div style="height:10px;"></div>

        <div class="app-grid">
            <div class="app-card" onclick="openModal('modal-quest')">
                <div class="app-title">QUEST BOARD</div>
                <div class="app-status">Active: <span id="m-count">0</span></div>
                <div class="app-icon-bg">‚öî</div>
            </div>
            <div class="app-card" onclick="openModal('modal-tuner')">
                <div class="app-title">NOISE TUNER</div>
                <div class="app-status">Signal Wave</div>
                <div class="app-icon-bg">üì°</div>
            </div>
            <div class="app-card" onclick="openModal('modal-vital')">
                <div class="app-title">VITAL KEEPER</div>
                <div class="app-status">Life Support</div>
                <div class="app-icon-bg">‚ô•</div>
            </div>
            <div class="app-card card-forbidden" onclick="openModal('modal-archive')">
                <div class="app-title">FORBIDDEN ARCHIVE</div>
                <div class="app-status" style="color:#aa5555;">[[ RESTRICTED ]]</div>
                <div class="app-icon-bg">üëÅ</div>
            </div>
        </div>
    </div>

    <div class="footer-info">CREDITS ACQUIRED: <span id="credit-val" style="color:var(--neon-gold);">0</span> G</div>

    <div id="modal-quest" class="modal">
        <div class="modal-header"><span class="modal-title">QUEST BOARD</span><span class="close-btn" onclick="closeModal('modal-quest')">√ó</span></div>
        <div class="modal-content">
            <div class="quest-input-area">
                <select id="quest-rank-sel">
                    <option value="S">S</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C" selected>C</option>
                </select>
                <input type="text" id="quest-in-text" placeholder="Mission Name...">
                <button id="quest-add-btn" onclick="addQuest()">ADD</button>
            </div>
            <div id="quest-list"></div>
        </div>
    </div>

    <div id="modal-tuner" class="modal">
        <div class="modal-header"><span class="modal-title">NOISE TUNER</span><span class="close-btn" onclick="closeModal('modal-tuner')">√ó</span></div>
        <div class="modal-content">
            <canvas id="viz-canvas" class="tuner-viz"></canvas>
            <div class="tuner-ctrl">
                <button class="arch-btn" style="border-color:var(--neon-cyan); color:var(--neon-cyan); width:150px; height:50px; font-size:14px;" onclick="toggleNoise()">I/O SWITCH</button>
            </div>
            <div style="text-align:center; font-size:10px; color:#666; margin-top:10px;">GENERATING PINK NOISE...</div>
        </div>
    </div>

    <div id="modal-vital" class="modal">
        <div class="modal-header"><span class="modal-title">VITAL KEEPER</span><span class="close-btn" onclick="closeModal('modal-vital')">√ó</span></div>
        <div class="modal-content" style="display:flex; flex-direction:column; align-items:center;">
            <div class="vital-pod">
                <div class="vital-ring"></div>
                <div class="vital-heart-line"></div>
                <div id="vital-timer">25:00</div>
            </div>
            <div style="display:flex; gap:20px; margin-top:20px;">
                <button class="arch-btn" style="border-color:var(--neon-pink); color:var(--neon-pink); width:100px;" onclick="startVital()">START</button>
                <button class="arch-btn" style="border-color:#555; color:#aaa; width:100px;" onclick="stopVital()">ABORT</button>
            </div>
        </div>
    </div>

    <div id="modal-archive" class="modal">
        <div class="modal-header">
            <span class="modal-title">FORBIDDEN ARCHIVE</span>
            <span class="close-btn" onclick="closeModal('modal-archive')">√ó</span>
        </div>
        <div class="modal-content" style="display:flex; flex-direction:column; height:100%;">
            <div style="display:flex; margin-bottom:10px;">
                <button class="arch-btn" onclick="sealArchive()">üîí SEAL</button>
                <button class="arch-btn" onclick="unsealArchive()">üîì UNSEAL</button>
                <button class="arch-btn" onclick="clearArchive()">üóë BURN</button>
            </div>
            <textarea id="archive-area" class="archive-editor" placeholder=">> Ë®òÈå≤„Éè „Ç≥„Ç≥„Éá ÈÄîÁµ∂„Ç®„ÉÜ„Ç§„É´..."></textarea>
            <div style="font-size:10px; color:#522; margin-top:5px; text-align:right;">SYSTEM: RED_PROTOCOL_ACTIVE</div>
        </div>
    </div>

    <script>
        // === CLOCK ===
        const days = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            
            document.getElementById('h-min').innerText = `${h}:${m}`;
            document.getElementById('sec').innerText = `${s}`;
            document.getElementById('date-text').innerText = now.toLocaleDateString();
            document.getElementById('day-text').innerText = `[${days[now.getDay()]}]`;

            // Random Glitch
            if(Math.random() < 0.03) { 
                const cw = document.getElementById('clock-wrapper');
                cw.classList.add('glitch-active');
                setTimeout(()=> cw.classList.remove('glitch-active'), 300);
            }
        }
        setInterval(updateClock, 1000); updateClock();

        // === WEATHER & BG ===
        async function fetchWeather() {
            try {
                // Shizuoka Coordinates
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.9756&longitude=138.3828&current_weather=true');
                const data = await res.json();
                const temp = data.current_weather.temperature;
                const code = data.current_weather.weathercode;
                
                document.getElementById('w-temp').innerText = `${temp}¬∞C`;
                
                let icon = "‚òÅ";
                let type = "cloudy";
                
                if(code <= 1) { icon="‚òÄ"; type="sunny"; }
                else if(code <= 3) { icon="‚õÖ"; type="cloudy"; }
                else if(code <= 48) { icon="üå´"; type="cloudy"; }
                else if(code <= 67) { icon="‚òÇ"; type="rain"; }
                else if(code <= 99) { icon="‚ö°"; type="thunder"; }
                
                document.getElementById('w-icon').innerText = icon;
                setBg(type);

            } catch(e) { console.log(e); }
        }
        function setBg(type) {
            document.querySelectorAll('.bg-layer').forEach(el => el.classList.remove('active'));
            document.getElementById('bg-'+type).classList.add('active');
            
            const rc = document.getElementById('rain-container');
            rc.innerHTML = "";
            if(type === 'rain' || type === 'thunder') {
                for(let i=0; i<30; i++){
                    let d = document.createElement('div');
                    d.className='rain-drop';
                    d.style.left = Math.random()*100+'vw';
                    d.style.animationDuration = (0.3+Math.random()*0.4)+'s';
                    d.style.animationDelay = Math.random()+'s';
                    rc.appendChild(d);
                }
            }
            if(type === 'thunder') {
                document.querySelector('.flash-overlay').style.animation = "flashAnim 5s infinite";
            } else {
                document.querySelector('.flash-overlay').style.animation = "none";
            }
        }
        fetchWeather(); setInterval(fetchWeather, 600000);

        // === MODALS ===
        function openModal(id) { 
            document.getElementById(id).classList.add('active'); 
            if(id==='modal-tuner') startVizLoop();
        }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            if(id==='modal-tuner') stopVizLoop();
            if(id==='modal-tuner' && isPlaying) toggleNoise(); // Stop noise when closed? optional.
        }

        // === QUEST BOARD (Rank System) ===
        let quests = JSON.parse(localStorage.getItem('quests_v3')) || [];
        let credits = parseInt(localStorage.getItem('credits')) || 0;
        document.getElementById('credit-val').innerText = credits;
        renderQuests();

        function addQuest() {
            const t = document.getElementById('quest-in-text').value;
            const r = document.getElementById('quest-rank-sel').value;
            if(t) {
                quests.push({t:t, r:r}); 
                saveQuests(); renderQuests();
                document.getElementById('quest-in-text').value = "";
            }
        }
        function renderQuests() {
            const el = document.getElementById('quest-list');
            el.innerHTML = "";
            let cnt = 0;
            quests.forEach((q,i) => {
                cnt++;
                const div = document.createElement('div');
                div.className = `quest-card qc-${q.r.toLowerCase()}`;
                div.innerHTML = `
                    <div class="rank-badge rank-${q.r}">${q.r}</div>
                    <div class="q-text">${q.t}</div>
                    <span style="color:#0f0; cursor:pointer;" onclick="delQuest(${i})">‚úî</span>
                `;
                el.appendChild(div);
            });
            document.getElementById('m-count').innerText = cnt;
        }
        function delQuest(i) {
            let reward = 100;
            const r = quests[i].r;
            if(r==='S') reward=500; else if(r==='A') reward=300; else if(r==='B') reward=150;
            quests.splice(i,1);
            credits += reward;
            localStorage.setItem('credits', credits);
            document.getElementById('credit-val').innerText = credits;
            saveQuests(); renderQuests();
        }
        function saveQuests() { localStorage.setItem('quests_v3', JSON.stringify(quests)); }

        // === NOISE TUNER (Active Viz) ===
        let audioCtx, noiseNode, gainNode, analyser, vizReq;
        let isPlaying = false;

        function toggleNoise() {
            if(!isPlaying) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(!audioCtx) audioCtx = new AudioContext();
                
                const bufferSize = 2 * audioCtx.sampleRate;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

                noiseNode = audioCtx.createBufferSource();
                noiseNode.buffer = buffer;
                noiseNode.loop = true;
                gainNode = audioCtx.createGain();
                gainNode.gain.value = 0.08; 
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;

                noiseNode.connect(gainNode);
                gainNode.connect(analyser);
                analyser.connect(audioCtx.destination);
                noiseNode.start();
                isPlaying = true;
            } else {
                if(noiseNode) noiseNode.stop();
                isPlaying = false;
            }
        }

        function startVizLoop() {
            const cvs = document.getElementById('viz-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight;

            function draw() {
                vizReq = requestAnimationFrame(draw);
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, cvs.width, cvs.height);

                if(!isPlaying || !analyser) {
                    ctx.strokeStyle = "#003300"; ctx.lineWidth=1;
                    ctx.beginPath(); ctx.moveTo(0, cvs.height/2); ctx.lineTo(cvs.width, cvs.height/2); ctx.stroke();
                    return;
                }

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteTimeDomainData(dataArray);

                ctx.lineWidth = 2;
                ctx.strokeStyle = "#00ff00";
                ctx.beginPath();
                const sliceWidth = cvs.width * 1.0 / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * cvs.height/2;
                    // More random chaos
                    const jitter = (Math.random()-0.5)*10; 
                    if(i===0) ctx.moveTo(x, y+jitter); else ctx.lineTo(x, y+jitter);
                    x += sliceWidth;
                }
                ctx.lineTo(cvs.width, cvs.height/2);
                ctx.stroke();
            }
            draw();
        }
        function stopVizLoop() { cancelAnimationFrame(vizReq); }

        // === VITAL KEEPER (Fixed) ===
        let vitalTime = 25*60;
        let vitalInt = null;
        function startVital() {
            if(vitalInt) return; // Prevent double start
            const el = document.getElementById('vital-timer');
            vitalInt = setInterval(()=>{
                vitalTime--;
                const m = Math.floor(vitalTime/60).toString().padStart(2,'0');
                const s = (vitalTime%60).toString().padStart(2,'0');
                el.innerText = `${m}:${s}`;
                if(vitalTime<=0) {
                    clearInterval(vitalInt); vitalInt=null;
                    alert("SEQUENCE COMPLETE");
                    resetVital();
                }
            }, 1000);
        }
        function stopVital() {
            if(vitalInt) clearInterval(vitalInt);
            vitalInt = null;
            resetVital();
        }
        function resetVital() {
            vitalTime = 25*60;
            document.getElementById('vital-timer').innerText = "25:00";
        }

        // === ARCHIVE ===
        const archiveArea = document.getElementById('archive-area');
        let rawText = localStorage.getItem('forbiddenText') || "";
        let isSealed = false;
        archiveArea.value = rawText;
        archiveArea.addEventListener('input', () => { if(!isSealed) { rawText = archiveArea.value; localStorage.setItem('forbiddenText', rawText); } });
        function sealArchive() {
            if(isSealed) return;
            isSealed = true;
            let scrambled = "";
            const chars = "‚Ä†‚Ä°¬ß¬∂#@&%¬£¬¢¬•‚Ç¨ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            for(let i=0; i<rawText.length; i++) scrambled += (rawText[i]==='\n')?'\n':chars.charAt(Math.floor(Math.random() * chars.length));
            archiveArea.value = scrambled;
            archiveArea.classList.add('encrypted-text');
            archiveArea.setAttribute('readonly', true);
        }
        function unsealArchive() {
            if(!isSealed) return;
            let counter = 0;
            const interval = setInterval(() => {
                let temp = ""; const chars = "0101010101";
                for(let i=0; i<rawText.length; i++) temp += (Math.random()>0.5)?rawText[i]:chars.charAt(Math.floor(Math.random()*chars.length));
                archiveArea.value = temp; counter++;
                if(counter > 10) {
                    clearInterval(interval);
                    archiveArea.value = rawText;
                    archiveArea.classList.remove('encrypted-text');
                    archiveArea.removeAttribute('readonly');
                    isSealed = false;
                }
            }, 50);
        }
        function clearArchive() {
            if(confirm("BURN DATA?")) {
                rawText = ""; archiveArea.value = ""; isSealed = false;
                archiveArea.classList.remove('encrypted-text');
                archiveArea.removeAttribute('readonly');
                localStorage.setItem('forbiddenText', "");
            }
        }
    </script>
</body>
</html>
